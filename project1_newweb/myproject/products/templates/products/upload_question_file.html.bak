{% extends 'products/base.html' %}
{% block title %}Upload file câu hỏi{% endblock %}
{% block content %}
<h2>Upload file câu hỏi cho {{ course.title }}</h2>
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
{% endif %}
<form id="uploadForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="mb-3">
        <label for="id_file" class="form-label">Chọn file:</label>
        <input type="file" name="file" id="id_file" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-primary">Upload</button>
</form>
<div id="uploadStatus"></div>

<script>
document.getElementById('id_file').addEventListener('change', function(e) {
    const fileInput = e.target;
    const formData = new FormData(document.getElementById('uploadForm'));
    const csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
    // Sử dụng giá trị từ Django với kiểm tra an toàn
    const courseId = '{{ course.id|default:0 }}'; // Nếu course.id không tồn tại, mặc định là 0

    if (!courseId || isNaN(courseId)) {
        document.getElementById('uploadStatus').innerHTML = '<div class="alert alert-danger">Lỗi: ID khóa học không hợp lệ.</div>';
        return;
    }

    fetch(`/course/${courseId}/upload/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        },
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        const statusDiv = document.getElementById('uploadStatus');
        if (data.status === 'success') {
            statusDiv.innerHTML = '<div class="alert alert-success">File uploaded successfully!</div>';
            fileInput.value = ''; // Reset input file
            setTimeout(() => { statusDiv.innerHTML = ''; }, 3000); // Xóa thông báo sau 3 giây
        } else {
            statusDiv.innerHTML = '<div class="alert alert-danger">Error: ' + (data.errors ? JSON.stringify(data.errors) : data.message) + '</div>';
        }
    })
    .catch(error => {
        document.getElementById('uploadStatus').innerHTML = '<div class="alert alert-danger">Lỗi upload: ' + error.message + '</div>';
    });
});
</script>
{% endblock %}